AWSTemplateFormatVersion: "2010-09-09"
Description: Lambda function with Function URL for Free2Kindle API

Parameters:
  ProjectName:
    Type: String
    Description: Name of the project (used for resource naming)

  SourceBucketName:
    Type: String
    Description: Name of the S3 bucket containing the Lambda source code

  SourceBucketKey:
    Type: String
    Description: S3 key for the Lambda source zip file

  MailjetAPIKey:
    Type: String
    NoEcho: true
    Description: Mailjet API key

  MailjetAPISecret:
    Type: String
    NoEcho: true
    Description: Mailjet API secret

  APIKeySecret:
    Type: String
    NoEcho: true
    Description: Secret API key for authentication

  DestEmail:
    Type: String
    Description: Kindle email address

  SenderEmail:
    Type: String
    Description: Verified sender email address

  SendEnabled:
    Type: String
    Description: Enable email sending
    Default: "false"

  Debug:
    Type: String
    Description: Debug flag
    Default: "false"

Resources:
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-lambda-exec"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess

  LambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-api"
      Description: Free2Kindle API - Article conversion and delivery service
      Runtime: provided.al2023
      Handler: bootstrap
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref SourceBucketName
        S3Key: !Ref SourceBucketKey
      Timeout: 540
      MemorySize: 256
      Environment:
        Variables:
          DEBUG: !Ref Debug
          F2K_API_KEY: !Ref APIKeySecret
          F2K_DEST_EMAIL: !Ref DestEmail
          F2K_SENDER_EMAIL: !Ref SenderEmail
          F2K_SEND_ENABLED: !Ref SendEnabled
          MAILJET_API_KEY: !Ref MailjetAPIKey
          MAILJET_API_SECRET: !Ref MailjetAPISecret
          F2K_DYNAMODB_TABLE_NAME: !Ref DynamoDBTable
          F2K_MODE: server
      TracingConfig:
        Mode: PassThrough

  LambdaFunctionUrl:
    Type: AWS::Lambda::Url
    Properties:
      AuthType: NONE
      InvokeMode: BUFFERED
      TargetFunctionArn: !GetAtt LambdaFunction.Arn

  LambdaFunctionUrlPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref LambdaFunction
      Action: lambda:InvokeFunctionUrl
      Principal: "*"
      FunctionUrlAuthType: NONE

  LambdaFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref LambdaFunction
      Action: lambda:InvokeFunction
      Principal: "*"

  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${ProjectName}-articles"
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST

  DynamoDBTableAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "${ProjectName}-dynamodb-access"
      Roles:
        - !Ref LambdaExecutionRole
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:PutItem
              - dynamodb:GetItem
              - dynamodb:Query
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
            Resource: !GetAtt DynamoDBTable.Arn

Outputs:
  FunctionName:
    Description: Name of the Lambda function
    Value: !Ref LambdaFunction

  FunctionArn:
    Description: ARN of the Lambda function
    Value: !GetAtt LambdaFunction.Arn

  FunctionUrl:
    Description: Function URL endpoint
    Value: !GetAtt LambdaFunctionUrl.FunctionUrl
    Export:
      Name: !Sub "${ProjectName}-function-url"

  DynamoDBTableName:
    Description: Name of the DynamoDB table for storing articles
    Value: !Ref DynamoDBTable
    Export:
      Name: !Sub "${ProjectName}-dynamodb-table-name"

  DynamoDBTableArn:
    Description: ARN of the DynamoDB table
    Value: !GetAtt DynamoDBTable.Arn
    Export:
      Name: !Sub "${ProjectName}-dynamodb-table-arn"
